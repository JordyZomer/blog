<!DOCTYPE html>
<html lang="en">
<a rel="me" href="https://infosec.exchange/@pwningsystems" hidden></a>
<script data-goatcounter="https://pwningsystems.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<head>
  
    <title>A story about an Apple and two fetches :: pwning.systems</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Mistreatment by Apple Security is unfortunately something you&amp;rsquo;re likely to come across on a regular basis. Usually this concerns people that conduct free work for Apple in their spare time by auditing their assets. Despite Apple&amp;rsquo;s website claiming the opposite, you&amp;rsquo;ll frequently find things like quiet patching, no credit, no bounties, and an appalling lack of communication.
This is unwise on Apple&amp;rsquo;s part because it frustrates people who find these bugs and disincentivizes them from sharing them with Apple." />
<meta name="keywords" content="apple, kernel, vulnerability" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://pwning.systems/posts/apple-kernel-vulnerability/" />




<link rel="stylesheet" href="https://pwning.systems/assets/style.css">

  <link rel="stylesheet" href="https://pwning.systems/assets/green.css">






<link rel="apple-touch-icon" href="https://pwning.systems/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://pwning.systems/img/favicon/green.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="https://pwning.systems/" />
  
    <meta name="twitter:creator" content="pwningsystems" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="A story about an Apple and two fetches">
<meta property="og:description" content="Mistreatment by Apple Security is unfortunately something you&#39;re likely to come across on a regular basis. Usually this concerns people that conduct free work for Apple in their spare time by auditing their assets. Despite Apple&#39;s website claiming the opposite, you&#39;ll frequently find things like quiet patching, no credit, no bounties, and an appalling lack of communication." />
<meta property="og:url" content="https://pwning.systems/posts/apple-kernel-vulnerability/" />
<meta property="og:site_name" content="pwning.systems" />

  <meta property="og:image" content="https://pwning.systems/">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2021-07-20 19:30:12 &#43;0200 CEST" />












</head>
<body class="green">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    pwning.systems
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/bugs">Bugs</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/index.xml">RSS</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/bugs">Bugs</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/index.xml">RSS</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://pwning.systems/posts/apple-kernel-vulnerability/">A story about an Apple and two fetches</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-07-20 
      </span>
    
    
    <span class="post-author">:: Jordy Zomer</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://pwning.systems/tags/kernel/">kernel</a>&nbsp;
    
    #<a href="https://pwning.systems/tags/apple/">apple</a>&nbsp;
    
    #<a href="https://pwning.systems/tags/vulnerability/">vulnerability</a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <p><em>Mistreatment by Apple Security is unfortunately something you&rsquo;re likely to come across on a regular basis. Usually this concerns people that conduct free work for Apple in their spare time by auditing their assets. Despite Apple&rsquo;s website claiming the opposite, you&rsquo;ll frequently find things like quiet patching, no credit, no bounties, and an appalling lack of communication.</em></p>
<p><em>This is unwise on Apple&rsquo;s part because it frustrates people who find these bugs and disincentivizes them from sharing them with Apple. Remember, every bug that gets reported to them (instead of being sold to some shady outfit) and that gets fixed subsequently is one that can not be exploited in the future to make your device less safe. The very least they can do to honour the work of independent researchers is to communicate clearly and give them credit where appropriate.</em></p>
<p>Last year on June 30th 2020, I discovered a vulnerability in Apple&rsquo;s kernel (darwin-xnu), which I promptly reported. On July 2, 2020, I received notification that my report had been examined and that they were looking into the issue. A few days later, I asked if I could be kept informed of any updates, and they indicated there were none at the time. I never heard from them again after that.</p>
<p>A few weeks ago on 24 June 2021, I found out that this vulnerability had been fixed for a while, unfortunately I have not received any updates or credits. On the basis of this, I sent an e-mail, to which I have not gotten a response to date.</p>
<p>When I discovered that the vulnerability had been resolved due to a new revision of the source code of darwin-xnu being posted on github, my report flashed through my mind, and I went to see if it had been fixed. I discovered using git blame that this vulnerability was already resolved 8 months ago (on January 11, 2021)! (<a href="https://github.com/apple/darwin-xnu/blame/2ff845c2e033bd0ff64b5b6aa6063a1f8f65aa32/bsd/nfs/nfs_vfsops.c#L2099">Git blame</a>)</p>
<p>So, let&rsquo;s have a look at this issue! The <code>mount()</code> syscall for &ldquo;nfs&rdquo; filesystems had a double fetch vulnerability.</p>
<p>In theory, a Double Fetch is a conditional competitive vulnerability. It is a battle for data access between kernel mode and user mode. Virtual memory locations are typically partitioned between kernel space and user space in modern operating systems such as Linux and BSD derivatives. More information regarding double fetch vulnerabilities can be found in my post  <a href="https://pwning.systems/posts/an-introduction-to-kernel-exploitation-part1/">&ldquo;An introduction to Kernel Exploitation Part 1&rdquo;</a>.</p>
<p>The first fetch occurs in <a href="https://github.com/apple/darwin-xnu/blob/a449c6a3b8014d9406c2ddbdc81795da24aa7443/bsd/nfs/nfs_vfsops.c#L1902">&ldquo;this&rdquo;</a> instance. In this case, the External Data Representation (XDR) variables are parsed in NFS. You&rsquo;re probably thinking right now What exactly is XDR? Externel Data Representation (<a href="https://datatracker.ietf.org/doc/html/rfc1832">XDR</a>) is a data format description language that can only be used to describe data. It isn&rsquo;t a programming language at all. This language allows you to describe complex data formats in a clear and succinct manner. The XDR &ldquo;programming&rdquo; language is similar to the C programming language. NFS and other protocols employ XDR to describe the format of their data.</p>
<p>So, in essence, they are copying the length of all XDR variables from userland, then doing a size check on the <code>argslength</code> variable that was just copied from userland:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">argslength <span style="color:#f92672">=</span> ntohl(argslength);
<span style="color:#75715e">/* put a reasonable limit on the size of the XDR args */</span>
<span style="color:#66d9ef">if</span> (argslength <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1024</span>) {
	error <span style="color:#f92672">=</span> E2BIG;
	<span style="color:#66d9ef">break</span>;
}
</code></pre></div><p>So obviously <code>argslength</code> cannot be greater than <code>(16*1024 = 16384);</code>. This is fine, it is most likely merely a standard. Afterwards it will round up the <code>argslength</code> and allocate an <code>xdrbuf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">/* allocate xdr buffer */</span>
xdrbuf <span style="color:#f92672">=</span> xb_malloc(xdr_rndup(argslength));
<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>xdrbuf) {
	error <span style="color:#f92672">=</span> ENOMEM;
	<span style="color:#66d9ef">break</span>;
}
</code></pre></div><p>So, after allocating this buffer, they attempt to copy all the XDR parameters from userspace on line 1920:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">if</span> (inkernel)
	bcopy(CAST_DOWN(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>, data), xdrbuf, argslength);
<span style="color:#66d9ef">else</span>
	error <span style="color:#f92672">=</span> copyin(data, xdrbuf, argslength);
<span style="color:#66d9ef">break</span>;
</code></pre></div><p>This will copy all arguments from <code>data</code> up to <code>argslength</code> to the freshly allocated <code>xdrbuf</code>. When this is done this will be passed to the mountnfs function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">error <span style="color:#f92672">=</span> mountnfs(xdrbuf, mp, ctx, <span style="color:#f92672">&amp;</span>vp);
</code></pre></div><p>Alright, let&rsquo;s take a look at the <code>mountnfs</code> function! This accepts our <code>xdrbuf</code> as an argument. Let&rsquo;s just get to the important things:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">/* set up NFS mount with args */</span>
xb_init_buffer(<span style="color:#f92672">&amp;</span>xb, xdrbuf, <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>XDRWORD);
xb_get_32(error, <span style="color:#f92672">&amp;</span>xb, val); <span style="color:#75715e">/* version */</span>
xb_get_32(error, <span style="color:#f92672">&amp;</span>xb, argslength); <span style="color:#75715e">/* args length */</span>
</code></pre></div><p>In this block, it will initialize <code>xb</code> using the <code>xb_init_buffer</code> function. So, <code>xb</code> is of the type <code>struct xdrbuf</code>. Let&rsquo;s take a glance at that definition first for context.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">struct</span> xdrbuf {
	<span style="color:#66d9ef">union</span> {
		<span style="color:#66d9ef">struct</span> {
			<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>                  xbb_base;       <span style="color:#75715e">/* base address of buffer */</span>
			size_t                  xbb_size;       <span style="color:#75715e">/* size of buffer */</span>
			size_t                  xbb_len;        <span style="color:#75715e">/* length of data in buffer */</span>
		} xb_buffer;
	} xb_u;
	<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>          xb_ptr;         <span style="color:#75715e">/* pointer to current position */</span>
	size_t          xb_left;        <span style="color:#75715e">/* bytes remaining in current buffer */</span>
	size_t          xb_growsize;    <span style="color:#75715e">/* bytes to allocate when growing */</span>
	xdrbuf_type     xb_type;        <span style="color:#75715e">/* type of xdr buffer */</span>
	<span style="color:#66d9ef">uint32_t</span>        xb_flags;       <span style="color:#75715e">/* XB_* (see below) */</span>
};
</code></pre></div><p>This structure, as we can see, will be initialized in <code>xb_init_buffer</code>, so let&rsquo;s have a look at that as well:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">/*
</span><span style="color:#75715e"> * initialize a single-buffer xdrbuf
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">xb_init_buffer</span>(<span style="color:#66d9ef">struct</span> xdrbuf <span style="color:#f92672">*</span>xbp, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf, size_t buflen)
{
	xb_init(xbp, XDRBUF_BUFFER);
	xbp<span style="color:#f92672">-&gt;</span>xb_u.xb_buffer.xbb_base <span style="color:#f92672">=</span> buf;
	xbp<span style="color:#f92672">-&gt;</span>xb_u.xb_buffer.xbb_size <span style="color:#f92672">=</span> buflen;
	xbp<span style="color:#f92672">-&gt;</span>xb_u.xb_buffer.xbb_len <span style="color:#f92672">=</span> buflen;
	xbp<span style="color:#f92672">-&gt;</span>xb_growsize <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>;
	xbp<span style="color:#f92672">-&gt;</span>xb_ptr <span style="color:#f92672">=</span> buf;
	xbp<span style="color:#f92672">-&gt;</span>xb_left <span style="color:#f92672">=</span> buflen;
	<span style="color:#66d9ef">if</span> (buf) { <span style="color:#75715e">/* when using an existing buffer, xb code should skip cleanup */</span>
		xbp<span style="color:#f92672">-&gt;</span>xb_flags <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>XB_CLEANUP;
	}
}
</code></pre></div><p>So this <code>bzero</code>&rsquo;s the entire xdrbuf structure and sets the type to <code>XDRBUF BUFFER</code>, then it sets the base address of the buffer to the <code>xdrbuf</code> that was copied from userland, sets the size of the buffer and the length of the data to 2 times <code>XDRWORD</code>, which equals 8, and it initializes some pointers to our <code>xdrbuf</code>. Once the <code>xdrbuf</code> struct has been initialized, they will continue to fetch some 32 bit data from the structure&rsquo;s pointer to our <code>xdrbuf</code> using <code>xb_get_32</code>. They will use this to get the <code>version</code> and the <code>argslength</code>. Notice that this <code>argslength</code> is an XDR variable within the <code>xdrbuf</code> that was copied into kernel space during the second <code>copyin</code> call. This indicates that a malicious thread could manipulate the <code>argslength</code> variable in userspace between the first fetch on line 1902 and the second fetch on line 1920.</p>
<p>After that, they will use <code>xb_init_buffer</code> to reinitialize the <code>xdrbuf</code> structure with the malicious size we changed in userspace, despite the fact that the actual size of the xdrbuf hasn&rsquo;t changed since the allocation with <code>xb_malloc</code>. A malicious attacker could then exploit this to cause a memory corruption bug.</p>
<p>So, now that we know how the bug operates, how did they resolve it? They&rsquo;ve checked to see if the <code>argslength</code> from the second fetch is the same as the <code>argslength</code> from the first copy. In this scenario, I believe that is a viable solution.</p>
<p>After notifying Apple about the silent patch without credit, I sent them another email on July 8th, warning them about this article. Because they did not respond, I am making this post public. I have a couple more bugs on the shelf which I am considering to write about for educational purposes.</p>
<p>I truly hope Apple changes the way they handle these kinds of bugs. In my opinion, the way they are managing such issues is a major reason why people contemplate selling vulnerabilities to third-party vendors like Zerodium.</p>
<p>In any case, it was a fun bug to discover and write about, and I hope you enjoyed this blog article. Good-bye!</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://pwning.systems/posts/sequoia-variant-analysis/">
                <span class="button__icon">←</span>
                <span class="button__text">Variant analysis of the &#39;Sequoia&#39; bug</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://pwning.systems/posts/setting-up-a-kernel-debugging-environment/">
                <span class="button__text">Setting Up a Kernel Debugging Environment</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>Jordy Zomer</span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://pwning.systems/assets/main.js"></script>
<script src="https://pwning.systems/assets/prism.js"></script>







  
</div>

</body>
</html>
